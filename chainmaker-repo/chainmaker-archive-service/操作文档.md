# 归档中心服务编译与启动
0. `归档中心服务`提供归档链上数据,查询已归档数据功能
1. 环境与依赖
    - linux 系统,开启mmap
    - golang 1.16+
    - 7zip 压缩工具
2. 下载chainmaker-archive-service源码
3. 编译代码
```powershell
cd chainmaker-archive-service/src 
go build -o chainmaker-archive-service
```
4. 启动服务 
```powershell
# 后台启动服务
nohup ./chainmaker-archive-service > service.log 2>&1 & 
# 记录下服务生成的token ,token用于调用压缩归档中心数据和管理证书的接口使用 
grep token ../log/processor.log | awk '{print $8}' | tail -1 > server_token
```
5. 配置文件 
```yml
# Logger settings
log:
  # Logger configuration file path.
  log_path: ../log 
  log_level: debug 
  log_in_console: false
  show_color: true
  max_size: 200 # MB
  max_backups: 3 
  max_age: 3 # day 
  compress: false
# api server setting 

http:
  port: 13119  
  ratelimit:
    # Ratelimit switch. Default is false.
    enabled: false

    # Rate limit type
    # 0: limit globally, 1: limit by ip
    type: 0

    # Token number added to bucket per second.
    # -1: unlimited, by default is 10000.
    token_per_second: -1

    # Token bucket size.
    # -1: unlimited, by default is 10000.
    token_bucket_size: -1

  white_list:
    enabled: false # 是否开启http的白名单
    address:
      - 127.0.0.1  # http接口白名单

# RPC service setting
rpc:
  # RPC port
  port: 13120 # grpc port    

  # Rate limit related settings
  # Here we use token bucket to limit rate.
  ratelimit:
    # Ratelimit switch. Default is false.
    enabled: false

    # Rate limit type
    # 0: limit globally, 1: limit by ip
    type: 0

    # Token number added to bucket per second.
    # -1: unlimited, by default is 10000.
    token_per_second: -1

    # Token bucket size.
    # -1: unlimited, by default is 10000.
    token_bucket_size: -1

  white_list:
    enabled: false # 是否开启rpc的白名单
    address:
      - 127.0.0.1  # rpc白名单
  tls_enable : false  # 只有ca证书的时候才设置为true，其余为false 
  # RPC TLS settings
  tls:
    # RPC TLS private key file path
    priv_key_file:  ../configs/server_cert/archive-server.key
    # RPC TLS public key file path
    cert_file:      ../configs/server_cert/archive-server.pem
    trust_ca_list: 
     # - ../configs/trust_list/archive-client.pem
      - ../configs/trust_list/baec-client-root.pem
     # - "configs/trust_list/ca1.ca"
     # - "configs/trust_list/ca2.ca"

  # RPC server max send/receive message size in MB
  max_send_msg_size: 200
  max_recv_msg_size: 200  


# Monitor related settings
monitor:
  # Monitor service switch, default is false.
  enabled: true

  # Monitor service port
  port: 13122

# PProf Settings
pprof:
  # If pprof is enabled or not
  enabled: true

  # PProf port
  port: 13123

# Storage config settings
storage_template:
  # 存储系统信息
  store_path: ../service_datas/system_info  
  # 存储链的block信息
  bfdb_path: ../service_datas/block_data
  # 存储链的索引信息
  index_path: ../service_datas/index_data
  # 存储链的压缩信息
  compress_path: ../service_datas/compress_data
  # 存储链的解压缩信息 
  decompress_path: ../service_datas/decompress_data

  # async write block in file block db to disk, default: false, so default is sync write disk
  logdb_segment_async: false

  # file size of .fdb, MB, default: 20
  logdb_segment_size: 128

  segment_cache_size: 3  

  use_mmap: true  
  # 扫描已经解压或已经压缩的文件列表的时间(秒)
  scan_interval_seconds: 300
  # 最大保留已解压或已压缩文件的时长(秒)   
  retain_seconds: 3600
  # compress_method: 7z # 7z or gzip
  
  leveldb_config: # level db 配置
    bloom_filter_bits: 10 

  
      
      




```
# 归档工具cmc的下载使用
1. `归档工具`从链上查询区块数据,将数据归档到`归档中心`；从`归档中心`查询已归档数据
1. 下载代码
1. 编译cmc工具
1. 配置cmc工具的归档中心
```powershell
cd chainmaker-go/tools/cmc
# 查询待归档链的0区块的hash
./cmc query block-by-height 0 \
--chain-id=chain1 \
--sdk-conf-path=./testdata/sdk_config.yml
# 进入归档中心cmc配置文件夹
cd archivecneter
# 修改chain_genesis_hash为查询到的0区块的genesishash

sed -i '1c chain_genesis_hash: xx' config.yml # 其中xx即为区块hash 

# 修改归档中心rpc服务地址 
sed -i '2c rpc_address: xxx' config.yml # 其中xxx为归档中心的rpc服务地址

```
4. 使用cmc工具归档链上的数据到归档中心 
```powershell
cd ../
# 归档链上 区块块高的1-610的数据 
./cmc archivecenter dump --sdk-conf-path ~/test-crypto/sdk_config.yml --chain-id chain1 --archive-conf-path ./archivecenter/config.yml --archive-begin-height 1 --archive-end-height 610

# cmc查询归档中心当前已归档数据状态命令
./cmc archivecenter  query archived-status --archive-conf-path archivecenter/config.yml 

# cmc查询归档中心,根据高度查区块命令
./cmc archivecenter query block-by-height 20 --archive-conf-path ./archivecenter/config.yml

# cmc查询归档中心,根据tx查询区块命令
./cmc archivecenter query block-by-txid [txid] --archive-conf-path ./archivecenter/config.yml

# cmc查询归档中心,根据tx查询事务命令
./cmc archivecenter query tx [txid] --archive-conf-path ./archivecenter/config.yml  

# cmc查询归档中心,根据hash查询区块命令
./cmc archivecenter query block-by-hash [blockhash]  --archive-conf-path ./archivecenter/config.yml
```
5. 归档中心配置cmc工具的配置文件   
```yml
chain_genesis_hash: bdaeaa2b435ad98d553019d1455234c4dd6341671018fd571b5498d68eacd7b5 #归档的链的块高为0的区块hash(hex编码)
rpc_address: 127.0.0.1:13120 #归档中心rpc服务地址
archive_center_http_url: http://127.0.0.1:13119 # 归档中心http服务地址,非必要
request_second_limit: 10 # 归档中心http请求超时时间,秒单位
tls_enable: false # 归档中心是否启用grpc的tls
tls: # 不开启grpc的tls的时候,如下配置可忽略
  server_name: baec-archive # 归档中心tls服务注册的名称
  priv_key_file: ./archivecenter/archive-client.key # cmc侧做tls的私钥
  cert_file: ./archivecenter/archive-client.pem # cmc侧做tls的证书
  trust_ca_list:
    - ./archivecenter/baec-root.pem # 归档中心服务根证书
max_send_msg_size: 200 # grpc 发送最大消息(MB为单位)
max_recv_msg_size: 200 # grpc 接收最大消息(MB为单位)
```

# 使用链区块数据扫描工具  
0. 根据配置信息扫描分析区块链的存储区块文件,给出哪些区块文件是可以被转移的
1. 下载代码chainmaker-archive-service 
2. 编译扫描工具 
```powershell
cd bfdb-clean-tools
go build

```
3. 拷贝扫描工具和配置文件到区块链节点所在的服务器
```powershell
# 拷贝扫描工具到链节点所在的服务器的某路径下
cp bfdb-clean-tools /[path]
cp config.yml /[path]
```
4. 配置扫描工具
```powershell
# 修改扫描的去块路径为区块链节点存储区块文件的路径
sed -i '8c bfdb_path: [chain-bfdb-path]' config.yml

# 修改扫描的区块高度为已经归档到归档中心的最大区块
sed -i '11c clean_height: [archived-height]' config.yml

# 扫描已经归档区块高度之下所有文件信息,生成csv文件
 ./bfdb-clean-tools 
```
5. 用户根据扫描出来的文件信息,自行将标记为可以删除的文件转移到廉价存储或者删除
6. 配置文件 
```yml
log:
  # Logger configuration file path.
  log_path: ./log 
  log_level: info   
  log_size: 100
  log_age: 30
  log_num: 100
bfdb_path: ./bfdb # 区块链节点存储区块bfdb文件的根文件夹目录
mode: 1 # 1 为输出清理信息模式; 2 为根据输出的清理信息,做文件清理；默认为1 
clean_stub: ./stub20221021151245.csv # 为清理信息模式输出的文件 
clean_height: 11120000 # 已经归档到归档中心的高度(可以清理的区块的最大高度) 

```