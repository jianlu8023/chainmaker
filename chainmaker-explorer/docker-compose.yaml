networks:
  explorer:
    name: "cm_explorer"

services:
  cm_explorer_db:
    image: mysql:8.4.2
    volumes:
      - ./compose/mysql/data:/var/lib/mysql
      - ./compose/mysql/source.d:/docker-entrypoint-initdb.d
    restart: always
    networks:
      - explorer
    #ports:
      #- "13306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: Baec&chainmaker
      MYSQL_USER: chainmaker
      MYSQL_PASSWORD: Baec&chainmaker
      MYSQL_DATABASE: chainmaker_explorer_dev
    command: [ 'mysqld', '--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci' ]
    healthcheck:
      retries: 3
      timeout: 5s
      interval: 60s
      test: ["CMD","mysqladmin","ping","-h","localhost","-u","root","-pBaec&chainmaker"]
    container_name: cm_explorer_db

  cm_explorer_server:
    image: chainmakerofficial/explorer-backend:v2.3.1
    depends_on:
      cm_explorer_db:
        condition: service_healthy
    ports:
      - "9997:9997"
    environment:
      show_config: 0
    restart: always
    container_name: cm_explorer_server
    hostname: cm_explorer_server
    networks:
      - explorer
    volumes:
      - ./compose/server/configs:/chainmaker-explorer-backend/configs
      - ./compose/server/logs:/chainmaker-explorer-backend/log
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  cm_explorer_web:
    depends_on:
      - cm_explorer_server
      - cm_explorer_web_evm
    image: chainmakerofficial/explorer-web:v2.3.1_evm
    ports:
      - "9996:8080"
    restart: always
    networks:
      - explorer
    container_name: cm_explorer_web
    hostname: cm_explorer_web
    command: /bin/sh -c "sleep 10 && nginx -g 'daemon off;'"  # 延迟 10 秒启动
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
  
  cm_explorer_web_evm:
    container_name: cm_explorer_web_evm
    hostname: cm_explorer_web_evm
    networks:
      - explorer
    image: chainmakerofficial/explorer-web:v2.3.1_extend
    ports:
      - "9995:9996"
    restart: always

